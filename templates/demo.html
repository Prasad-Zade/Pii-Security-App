{% extends "base.html" %}

{% block title %}Demo - PII Privacy Protection{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-play"></i> Interactive Demo</h2>
            <p class="text-muted">Test the functional dependency-based privacy masking system</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-edit"></i> Input Text</h5>
                </div>
                <div class="card-body">
                    <textarea id="inputText" class="form-control" rows="6" 
                              placeholder="Enter text with PII entities...&#10;&#10;Examples:&#10;• Customer John Smith, order ID ORD123, count letters in John Smith's name&#10;• Buyer Jane Doe, seller Amazon, what's artificial intelligence?&#10;• User Mike Davis, email mike@email.com, deliver package to address"></textarea>
                    
                    <div class="mt-3">
                        <button id="processBtn" class="btn btn-primary">
                            <i class="fas fa-shield-alt"></i> Process Text
                        </button>
                        <button id="clearBtn" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Quick Examples:</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <button class="btn btn-outline-info btn-sm example-btn" 
                                    data-text="Customer Rajesh Kumar, order ID ORD12345, count letters in Rajesh Kumar's name">
                                Name Analysis Query
                            </button>
                            <button class="btn btn-outline-info btn-sm example-btn" 
                                    data-text="Buyer Priya Sharma, seller Amazon, what's artificial intelligence?">
                                General Knowledge Query
                            </button>
                            <button class="btn btn-outline-info btn-sm example-btn" 
                                    data-text="Customer John Smith, order ID TXN456, deliver package to address">
                                Functional Operation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-eye-slash"></i> Masked Output</h5>
                </div>
                <div class="card-body">
                    <div id="results" style="display: none;">
                        <div class="mb-3">
                            <strong>Original:</strong>
                            <div id="originalText" class="border p-2 bg-light rounded"></div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Masked:</strong>
                            <div id="maskedText" class="border p-2 bg-warning bg-opacity-25 rounded"></div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h6>Privacy Score</h6>
                                        <h4 id="privacyScore">0%</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h6>Processing Time</h6>
                                        <h4 id="processingTime">0ms</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Kept Entities:</strong>
                            <div id="keptEntities" class="mt-2"></div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Masked Entities:</strong>
                            <div id="maskedEntities" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <div id="loading" style="display: none;" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="mt-2">Analyzing functional dependencies...</p>
                    </div>
                    
                    <div id="placeholder" class="text-center text-muted">
                        <i class="fas fa-arrow-left fa-2x mb-3"></i>
                        <p>Enter text and click "Process Text" to see results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Processing History</h5>
                </div>
                <div class="card-body">
                    <div id="history"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Session Statistics</h5>
                </div>
                <div class="card-body">
                    <div id="stats" class="row"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputText = document.getElementById('inputText');
    const processBtn = document.getElementById('processBtn');
    const clearBtn = document.getElementById('clearBtn');
    const results = document.getElementById('results');
    const loading = document.getElementById('loading');
    const placeholder = document.getElementById('placeholder');
    
    // Example buttons
    document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            inputText.value = this.dataset.text;
        });
    });
    
    // Clear button
    clearBtn.addEventListener('click', function() {
        inputText.value = '';
        results.style.display = 'none';
        placeholder.style.display = 'block';
    });
    
    // Process button
    processBtn.addEventListener('click', async function() {
        const text = inputText.value.trim();
        if (!text) {
            alert('Please enter some text to process');
            return;
        }
        
        // Show loading
        placeholder.style.display = 'none';
        results.style.display = 'none';
        loading.style.display = 'block';
        processBtn.disabled = true;
        
        try {
            const response = await fetch('/api/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                displayResults(data);
                loadHistory();
                loadStats();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        } finally {
            loading.style.display = 'none';
            processBtn.disabled = false;
        }
    });
    
    function displayResults(data) {
        document.getElementById('originalText').textContent = data.original_text;
        document.getElementById('maskedText').textContent = data.masked_text;
        document.getElementById('privacyScore').textContent = data.privacy_score.toFixed(1) + '%';
        document.getElementById('processingTime').textContent = (data.processing_time * 1000).toFixed(1) + 'ms';
        
        // Kept entities
        const keptDiv = document.getElementById('keptEntities');
        keptDiv.innerHTML = '';
        data.kept_entities.forEach(entity => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success entity-badge';
            badge.textContent = `${entity.text} (${entity.type})`;
            keptDiv.appendChild(badge);
        });
        
        // Masked entities
        const maskedDiv = document.getElementById('maskedEntities');
        maskedDiv.innerHTML = '';
        data.masked_entities.forEach(entity => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-danger entity-badge';
            badge.textContent = `${entity.original} → ${entity.replacement} (${entity.type})`;
            maskedDiv.appendChild(badge);
        });
        
        results.style.display = 'block';
    }
    
    async function loadHistory() {
        try {
            const response = await fetch('/api/history');
            const history = await response.json();
            
            const historyDiv = document.getElementById('history');
            historyDiv.innerHTML = '';
            
            if (history.length === 0) {
                historyDiv.innerHTML = '<p class="text-muted">No processing history yet</p>';
                return;
            }
            
            history.slice(-5).reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = 'border-bottom pb-2 mb-2';
                div.innerHTML = `
                    <small class="text-muted">${new Date(item.timestamp).toLocaleString()}</small>
                    <br>
                    <strong>Input:</strong> ${item.result.original_text.substring(0, 100)}...
                    <br>
                    <span class="badge bg-success">Privacy: ${item.result.privacy_score.toFixed(1)}%</span>
                    <span class="badge bg-info">Time: ${(item.result.processing_time * 1000).toFixed(1)}ms</span>
                `;
                historyDiv.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading history:', error);
        }
    }
    
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h6>Total Processed</h6>
                            <h4>${stats.total_processed}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h6>Avg Privacy Score</h6>
                            <h4>${stats.avg_privacy_score}%</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h6>Avg Processing Time</h6>
                            <h4>${(stats.avg_processing_time * 1000).toFixed(1)}ms</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h6>Entity Types</h6>
                            <h4>${Object.keys(stats.entity_types).length}</h4>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    // Load initial data
    loadHistory();
    loadStats();
});
</script>
{% endblock %}